// Configuración de OAuth2 Discord
const CLIENT_ID = "1352110749169750038"; // Reemplaza con tu Client ID
const CLIENT_SECRET = "KqcBar4uoh1HoU1vf5ygjoOgDkUicvJx"; // Reemplaza con tu Client Secret
const REDIRECT_URI = "https://k1ontop.github.io/kaitruxweb/servers.html"; // Reemplaza con tu URL de callback
const DISCORD_API = "https://discord.com/api";

// Funciones para manejar la autenticación
function login() {
    const scope = "identify guilds";
    const authUrl = `${DISCORD_API}/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${scope}`;
    window.location.href = authUrl;
}

// Función para manejar el callback después de autenticación
async function handleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    if (code) {
        try {
            // Intercambiar código por token
            const tokenResponse = await fetch(`${DISCORD_API}/oauth2/token`, {
                method: 'POST',
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI
                }),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });

            const tokenData = await tokenResponse.json();
            if (tokenData.access_token) {
                localStorage.setItem('discord_token', tokenData.access_token);
                localStorage.setItem('discord_refresh_token', tokenData.refresh_token);
                localStorage.setItem('discord_token_expiry', Date.now() + (tokenData.expires_in * 1000));

                // Obtener información del usuario
                await fetchUserInfo();

                // Redirigir a la página de servidores
                window.location.href = '/servers.html';
            } else {
                console.error('Error al obtener el token:', tokenData);
            }
        } catch (error) {
            console.error('Error al intercambiar el código por token:', error);
        }
    }
}

// Función para verificar la autenticación
function checkAuth() {
    const token = localStorage.getItem('discord_token');
    const tokenExpiry = localStorage.getItem('discord_token_expiry');

    if (token && Date.now() < tokenExpiry) {
        // Usuario autenticado
        document.querySelectorAll('.auth-required').forEach(el => {
            el.style.display = 'block';
        });
        document.querySelectorAll('.auth-not-required').forEach(el => {
            el.style.display = 'none';
        });

        // Cargar información del usuario almacenada
        const userData = JSON.parse(localStorage.getItem('discord_user') || '{}');
        if (userData.id) {
            updateUIWithUserInfo(userData);
        } else {
            fetchUserInfo();
        }

        return true;
    } else {
        // Usuario no autenticado
        document.querySelectorAll('.auth-required').forEach(el => {
            el.style.display = 'none';
        });
        document.querySelectorAll('.auth-not-required').forEach(el => {
            el.style.display = 'block';
        });

        return false;
    }
}

// Función para obtener información del usuario
async function fetchUserInfo() {
    const token = localStorage.getItem('discord_token');
    if (!token) return;

    try {
        const response = await fetch(`${DISCORD_API}/users/@me`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        if (response.ok) {
            const userData = await response.json();
            localStorage.setItem('discord_user', JSON.stringify(userData));
            updateUIWithUserInfo(userData);
        } else {
            console.error('Error al obtener la información del usuario:', response.statusText);
        }
    } catch (error) {
        console.error('Error en la solicitud de información del usuario:', error);
    }
}

// Función para actualizar la interfaz de usuario con la información del usuario
function updateUIWithUserInfo(userData) {
    const userInfoElement = document.getElementById('user-info');
    if (userInfoElement) {
        userInfoElement.innerHTML = `Bienvenido, ${userData.username}!`;
    }
}

// Función para cerrar sesión
function logout() {
    localStorage.removeItem('discord_token');
    localStorage.removeItem('discord_refresh_token');
    localStorage.removeItem('discord_token_expiry');
    localStorage.removeItem('discord_user');
    localStorage.removeItem('discord_guilds');

    window.location.href = '/';
}

// Función para cargar los servidores del usuario
async function fetchUserGuilds() {
    console.log('Fetching user guilds...');
    const token = localStorage.getItem('discord_token');
    if (!token) {
        console.error('Token de acceso no encontrado.');
        return;
    }

    try {
        const response = await fetch('https://discord.com/api/users/@me/guilds', {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        if (!response.ok) {
            console.error('Error al obtener los servidores:', response.statusText);
            return;
        }

        const guilds = await response.json();
        console.log('Servidores obtenidos:', guilds);

        // Lógica para mostrar los servidores en la interfaz de usuario
        categorizeAndDisplayGuilds(guilds, JSON.parse(localStorage.getItem('bot_guilds') || '[]'));
    } catch (error) {
        console.error('Error en la solicitud de servidores:', error);
    }
}

// Función para categorizar y mostrar los servidores
function categorizeAndDisplayGuilds(guilds, botGuilds) {
    const guildsWithBot = guilds.filter(guild => botGuilds.includes(guild.id));
    const guildsWithoutBot = guilds.filter(guild => !botGuilds.includes(guild.id));

    displayGuilds(guildsWithBot, 'guilds-with-bot');
    displayGuilds(guildsWithoutBot, 'guilds-without-bot');
}

// Función para mostrar los servidores en el DOM
function displayGuilds(guilds, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';
    guilds.forEach(guild => {
        const guildElement = document.createElement('div');
        guildElement.classList.add('guild-item', 'p-4', 'bg-gray-800', 'rounded-lg', 'shadow-md');
        guildElement.innerHTML = `
            <h4 class="text-lg font-semibold">${guild.name}</h4>
            <p class="text-gray-400">${guild.id}</p>
        `;
        container.appendChild(guildElement);
    });
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    // Verificar si estamos en la página de callback
    if (window.location.pathname === '/servers.html') {
        handleCallback();
        return;
    }

    // Comprobar estado de autenticación
    const isAuthenticated = checkAuth();

    // Añadir evento al botón de login
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.addEventListener('click', login);
    }

    // Si estamos en la página de servidores y el usuario está autenticado
    if (window.location.pathname === '/servers.html' && isAuthenticated) {
        const guildsData = JSON.parse(localStorage.getItem('discord_guilds') || '[]');
        const botGuilds = JSON.parse(localStorage.getItem('bot_guilds') || '[]');

        if (guildsData.length > 0) {
            categorizeAndDisplayGuilds(guildsData, botGuilds);
        } else {
            fetchUserGuilds();
        }
    }
});
